<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Introduction Destructive malware is some of the most dangerous software out there. Where a malicious coin miner might slow down your system or a RAT might be used to exfiltrate sensitive data, destructive malware exists for one purpose, causing damage. Arguably one of the most popular cyber attacks in history Stuxnet, was destructive in nature. The main aspect of ransomware that makes it so dangerous is it&amp;rsquo;s destructive nature, if it didn&amp;rsquo;t encrypt a system and make it unusable would anyone pay the ransom?"><title>Deconstructing WhisperGate</title><link rel=canonical href=https://demo.stack.jimmycai.com/p/whispergate/><link rel=stylesheet href=/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="Deconstructing WhisperGate"><meta property="og:description" content="Introduction Destructive malware is some of the most dangerous software out there. Where a malicious coin miner might slow down your system or a RAT might be used to exfiltrate sensitive data, destructive malware exists for one purpose, causing damage. Arguably one of the most popular cyber attacks in history Stuxnet, was destructive in nature. The main aspect of ransomware that makes it so dangerous is it&amp;rsquo;s destructive nature, if it didn&amp;rsquo;t encrypt a system and make it unusable would anyone pay the ransom?"><meta property="og:url" content="https://demo.stack.jimmycai.com/p/whispergate/"><meta property="og:site_name" content="Nathan's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Destructive Malware"><meta property="article:tag" content="Yara"><meta property="article:published_time" content="2022-01-16T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-16T00:00:00+00:00"><meta property="og:image" content="https://demo.stack.jimmycai.com/p/whispergate/whisper.jpg"><meta name=twitter:title content="Deconstructing WhisperGate"><meta name=twitter:description content="Introduction Destructive malware is some of the most dangerous software out there. Where a malicious coin miner might slow down your system or a RAT might be used to exfiltrate sensitive data, destructive malware exists for one purpose, causing damage. Arguably one of the most popular cyber attacks in history Stuxnet, was destructive in nature. The main aspect of ransomware that makes it so dangerous is it&amp;rsquo;s destructive nature, if it didn&amp;rsquo;t encrypt a system and make it unusable would anyone pay the ransom?"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://demo.stack.jimmycai.com/p/whispergate/whisper.jpg"><link rel="shortcut icon" href=favicon.svg></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hua21f330812822faaf581c7ecbb0903bf_62333_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Nathan's Blog</a></h1><h2 class=site-description>Hacker, Reader, and Friend</h2></div></header><ol class=social-menu><li><a href=https://github.com/AlbinoGazelle target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href target=_blank title=mail rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><polyline points="3 7 12 13 21 7"/></svg></a></li><li><a href=https://twitter.com/AlbinoGazelle target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#iocs>IOCs</a><ol><li><a href=#stage-1>Stage 1:</a><ol><li><a href=#sha256>SHA256:</a></li><li><a href=#unique-strings>Unique Strings:</a></li><li><a href=#system-behavior>System Behavior:</a></li><li><a href=#virustotal>VirusTotal:</a></li></ol></li><li><a href=#stage-2>Stage 2:</a><ol><li><a href=#sha256-1>SHA256:</a></li><li><a href=#unique-strings-1>Unique Strings:</a></li><li><a href=#system-behavior-1>System Behavior:</a></li><li><a href=#virustotal-1>VirusTotal:</a></li></ol></li><li><a href=#stage-3>Stage 3:</a><ol><li><a href=#sha256-2>SHA256:</a></li><li><a href=#virustotal-2>VirusTotal:</a></li></ol></li><li><a href=#stage-4>Stage 4:</a><ol><li><a href=#sha256-3>SHA256:</a></li><li><a href=#unique-strings-2>Unique Strings:</a></li><li><a href=#system-behavior-2>System Behavior:</a></li><li><a href=#virustotal-3>VirusTotal:</a></li></ol></li></ol></li><li><a href=#stage-1-1>Stage 1</a><ol><li><a href=#detection-rules>Detection Rules:</a><ol><li><a href=#yara>Yara:</a></li></ol></li><li><a href=#mitre-attck-techniques>MITRE ATT&CK Techniques</a></li></ol></li><li><a href=#stage-2-1>Stage 2</a><ol><li><a href=#detection-rules-1>Detection Rules:</a><ol><li><a href=#yara-1>YARA:</a></li></ol></li><li><a href=#mitre-attck-techniques-1>MITRE ATT&CK Techniques</a></li></ol></li><li><a href=#stage-3-1>Stage 3</a></li><li><a href=#stage-4-1>Stage 4</a><ol><li><a href=#lab-analysis>Lab Analysis:</a></li><li><a href=#sysmon-logs-generated>Sysmon logs generated:</a></li><li><a href=#detection-rules-2>Detection Rules:</a><ol><li><a href=#yara-2>Yara:</a></li></ol></li><li><a href=#mitre-attck-techniques-2>MITRE ATT&CK Techniques:</a></li></ol></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References:</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/whispergate/><img src=/p/whispergate/whisper_hu99a54d96029b77e75edf6d51ed44e6da_1324271_800x0_resize_q75_box.jpg srcset="/p/whispergate/whisper_hu99a54d96029b77e75edf6d51ed44e6da_1324271_800x0_resize_q75_box.jpg 800w, /p/whispergate/whisper_hu99a54d96029b77e75edf6d51ed44e6da_1324271_1600x0_resize_q75_box.jpg 1600w" width=800 height=575 loading=lazy alt="Featured image of post Deconstructing WhisperGate"></a></div><div class=article-details><header class=article-category><a href=/categories/reverse-engineering/ style=background-color:#2a9d8f;color:#fff>Reverse Engineering</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/whispergate/>Deconstructing WhisperGate</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 16, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><h1 id=introduction>Introduction</h1><p>Destructive malware is some of the most dangerous software out there. Where a malicious coin miner might slow down your system or a RAT might be used to exfiltrate sensitive data, destructive malware exists for one purpose, causing damage. Arguably one of the most popular cyber attacks in history Stuxnet, was destructive in nature. The main aspect of ransomware that makes it so dangerous is it&rsquo;s destructive nature, if it didn&rsquo;t encrypt a system and make it unusable would anyone pay the ransom?</p><p>On 1/15/2022 Microsoft released information on a new campaign targetting Ukrainian systems with destructive malware. It includes four different stages:</p><ol><li>A purely destructive MBR wiper that displays a ransom note on next bootup.</li><li>Downloader that&rsquo;s used to download other stages of the attack.</li><li>Payload that adds an exclusion to Windows Defender and allows the final stage to be ran.</li><li>File corrupter that will corrupt any files with a specific extension.</li></ol><h2 id=iocs>IOCs</h2><h3 id=stage-1>Stage 1:</h3><h4 id=sha256>SHA256:</h4><p><code>a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92</code></p><h4 id=unique-strings>Unique Strings:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>8BEDC411012A33BA34F49130D0F186993C6A32DAD8976F6A5D82C1ED23054C057ECED5496F65
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>You should pay us  $10k via bitcoin wallet
</span></span></code></pre></td></tr></table></div></div><h4 id=system-behavior>System Behavior:</h4><p>Overwritting &ldquo;\\.\PhysicalDrive0&rdquo; (MBR) with 512 bytes of the ransom note.</p><h4 id=virustotal>VirusTotal:</h4><p><a class=link href=https://www.virustotal.com/gui/file/a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92/detection target=_blank rel=noopener>https://www.virustotal.com/gui/file/a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92/detection</a></p><h3 id=stage-2>Stage 2:</h3><h4 id=sha256-1>SHA256:</h4><p><code>dcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78</code></p><h4 id=unique-strings-1>Unique Strings:</h4><p>:::info
Make sure to specify 16 byte length when running strings <code>strings -e b file_name</code> to see these.
:::</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>DxownxloxadDxatxxax
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ttps://cdn.discordapp.com/attachments/928503440139771947/930108637681184768/Tbopbh.jpg
</span></span></code></pre></td></tr></table></div></div><h4 id=system-behavior-1>System Behavior:</h4><p>Powershell executing a base64 encoded payload.<br>DNS request and subsequent file download from cdn.discordapp.com</p><h4 id=virustotal-1>VirusTotal:</h4><p><a class=link href=https://www.virustotal.com/gui/file/dcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78 target=_blank rel=noopener>https://www.virustotal.com/gui/file/dcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78</a></p><h3 id=stage-3>Stage 3:</h3><h4 id=sha256-2>SHA256:</h4><p><code>9ef7dbd3da51332a78eff19146d21c82957821e464e8133e9594a07d716d892d</code></p><h4 id=virustotal-2>VirusTotal:</h4><p><a class=link href=https://www.virustotal.com/gui/file/9ef7dbd3da51332a78eff19146d21c82957821e464e8133e9594a07d716d892d target=_blank rel=noopener>https://www.virustotal.com/gui/file/9ef7dbd3da51332a78eff19146d21c82957821e464e8133e9594a07d716d892d</a></p><h3 id=stage-4>Stage 4:</h3><h4 id=sha256-3>SHA256:</h4><p><code>34ca75a8c190f20b8a7596afeb255f2228cb2467bd210b2637965b61ac7ea907</code></p><h4 id=unique-strings-2>Unique Strings:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cmd.exe /min /C ping 111.111.111.111 -n 5 -w 10 &gt; Nul &amp; Del /f /q &#34;%s&#34;
</span></span></code></pre></td></tr></table></div></div><h4 id=system-behavior-2>System Behavior:</h4><p>Mass file writing and data corruption.<br>Pinging 111.111.111.111 and then deleting itself.</p><h4 id=virustotal-3>VirusTotal:</h4><p><a class=link href=https://www.virustotal.com/gui/file/34ca75a8c190f20b8a7596afeb255f2228cb2467bd210b2637965b61ac7ea907 target=_blank rel=noopener>https://www.virustotal.com/gui/file/34ca75a8c190f20b8a7596afeb255f2228cb2467bd210b2637965b61ac7ea907</a></p><h2 id=stage-1-1>Stage 1</h2><p>Stage 1 is a pretty basic executable. Essentially all it does is overwrite the MBR with the ransom note. It uses <em>CreateFileW</em> to create a file handler pointing to the Master Boot Record and uses <em>WriteFile</em> to overwrite the MBR with the ransom note.</p><p>Once this stage is executed the host machine is left inoperable. Interestingly enough, if a machine is utilizing UEFI (and cmon, its 2022. Every machine should be) the ransom note <strong>will not</strong> be displayed on next bootup but the host will still be inoperable.</p><p>Screenshot of impacted host:
<img src=https://media.discordapp.net/attachments/437733241496141826/937151814409793556/unknown.png loading=lazy alt=Image></p><p>The ransom note is quite humorous as by the time any user sees this message, the computer has been damaged and the MBR already wiped and there is no function to fix any damage caused. Thankfully no one has fallen for this and the BTC address has not received much BTC at the time of this post:
<a class=link href=https://www.blockchain.com/btc/address/1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv target=_blank rel=noopener>1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv</a></p><p><img src=/p/whispergate/Pasted_image_20220129094431.png width=784 height=335 srcset="/p/whispergate/Pasted_image_20220129094431_huabf36fdd2d46129dbb4886a5c9c4c37d_26995_480x0_resize_box_3.png 480w, /p/whispergate/Pasted_image_20220129094431_huabf36fdd2d46129dbb4886a5c9c4c37d_26995_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=234 data-flex-basis=561px></p><p>Decompiled wiper function:
<img src=/p/whispergate/Pasted_image_20220129093558.png width=706 height=145 srcset="/p/whispergate/Pasted_image_20220129093558_hud364b51e44e62b5c90424431657e225e_28472_480x0_resize_box_3.png 480w, /p/whispergate/Pasted_image_20220129093558_hud364b51e44e62b5c90424431657e225e_28472_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=486 data-flex-basis=1168px></p><h3 id=detection-rules>Detection Rules:</h3><h4 id=yara>Yara:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rule whispergate_stage_1 {
</span></span><span class=line><span class=cl>    meta:
</span></span><span class=line><span class=cl>        author = &#34;Nathan Burns&#34;
</span></span><span class=line><span class=cl>        date = &#34;1/30/2022&#34;
</span></span><span class=line><span class=cl>        md5 = &#34;5d5c99a08a7d927346ca2dafa7973fc1&#34;
</span></span><span class=line><span class=cl>    strings:
</span></span><span class=line><span class=cl>       $s1 = &#34;1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv&#34;
</span></span><span class=line><span class=cl>       $s2 = &#34;8BEDC411012A33BA34F49130D0F186993C6A32DAD8976F6A5D82C1ED23054C057ECED5496F65&#34;
</span></span><span class=line><span class=cl>       $f1 = &#34;WriteFile&#34;
</span></span><span class=line><span class=cl>       $f2 = &#34;CreateFileW&#34;
</span></span><span class=line><span class=cl>    condition:
</span></span><span class=line><span class=cl>       1 of ($s*) and 1 of ($f*)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=mitre-attck-techniques>MITRE ATT&CK Techniques</h3><p><a class=link href=https://attack.mitre.org/techniques/T1561/002/ target=_blank rel=noopener>T1561.002 - Disk Structure Wipe</a><br><a class=link href=https://attack.mitre.org/techniques/T1491/001/ target=_blank rel=noopener>T1491.001 - Internal Defacement</a></p><h2 id=stage-2-1>Stage 2</h2><p>Stage 2 is where it gets more complex. It contains obfuscated code and starts downloading the next stage. I have zero experience decompiling .NET malware, but I was able to grab some interesting strings and see some weird behavior. A very interesting string is that this stage attempts to pull malware from discord, behavior that&rsquo;s been seen in the <a class=link href=https://cyware.com/news/abuse-of-discord-cdn-witnesses-significant-rise-277d273d target=_blank rel=noopener>past.</a></p><p><img src=/p/whispergate/Pasted_image_20220129125130.png width=720 height=89 srcset="/p/whispergate/Pasted_image_20220129125130_hu19efaee94e6c2a5aabbd3f97bf582b70_9528_480x0_resize_box_3.png 480w, /p/whispergate/Pasted_image_20220129125130_hu19efaee94e6c2a5aabbd3f97bf582b70_9528_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=808 data-flex-basis=1941px></p><p>It also attempts to evade detection by &ldquo;obfuscating&rdquo; some variables
<img src=/p/whispergate/Pasted_image_20220129125228.png width=424 height=80 srcset="/p/whispergate/Pasted_image_20220129125228_hu269e446a133117cb154177a2af698962_5510_480x0_resize_box_3.png 480w, /p/whispergate/Pasted_image_20220129125228_hu269e446a133117cb154177a2af698962_5510_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=530 data-flex-basis=1272px></p><p>It&rsquo;s my guess that this stage is purely a dropper for stage 3, but my .NET decompilation skills are extremely weak so I decided to just run it in a closed lab environment with some sysmon rules. I plan on making a blogpost later on after I create a more detailed and <em>hopefully</em> safer malware analysis lab.</p><p>Anyways, this was the behavior I spotted after running it in a lab environment.</p><p>The first thing it does it run this obfuscated powershell command:</p><p><img src=https://media.discordapp.net/attachments/437733241496141826/937211009926594650/vmware_gEbM5IIhfa.png loading=lazy alt=Image></p><p>Decoded command:</p><p><img src=https://media.discordapp.net/attachments/437733241496141826/937211008685047838/vmware_FIWwAGCyAz.png loading=lazy alt=Image></p><p>This command sleeps the script for 10 seconds until it downloads the stage 3 binary from <strong>cdn.discordapp.com</strong>, presumably using the obfuscated <strong>DownloadData</strong> powershell command.</p><p><img src=https://media.discordapp.net/attachments/437733241496141826/937211009184186418/vmware_ZTnw9fJTgk.png loading=lazy alt=Image></p><p>This is all I could gather from the stage 2 binary, but it most certainly executes the stage 3 binary after successful download as well.</p><h3 id=detection-rules-1>Detection Rules:</h3><h4 id=yara-1>YARA:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rule whispergate_stage_2 {
</span></span><span class=line><span class=cl>    meta:
</span></span><span class=line><span class=cl>        author = &#34;Nathan Burns&#34;
</span></span><span class=line><span class=cl>        date = &#34;1/30/2022&#34;
</span></span><span class=line><span class=cl>        md5 = &#34;14c8482f302b5e81e3fa1b18a509289d&#34;
</span></span><span class=line><span class=cl>	strings:
</span></span><span class=line><span class=cl>		$s1 = &#34;DxownxloxadDxatxxax&#34; wide ascii
</span></span><span class=line><span class=cl>		$s2 = &#34;ttps://cdn.discordapp.com/attachments/928503440139771947/930108637681184768/Tbopbh.jpg&#34; wide ascii
</span></span><span class=line><span class=cl>	condition:
</span></span><span class=line><span class=cl>		$s1 or $s2
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=mitre-attck-techniques-1>MITRE ATT&CK Techniques</h3><p><a class=link href=https://attack.mitre.org/techniques/T1059/001/ target=_blank rel=noopener>T1059.001 - Command and Scripting Interpreter: PowerShell</a><br><a class=link href=https://attack.mitre.org/techniques/T1583/006/ target=_blank rel=noopener>T1583.006 - Acquire Infrastructure: Web Services</a></p><h2 id=stage-3-1>Stage 3</h2><p>Unfortunately I couldn&rsquo;t get my hands on the original stage 3 binary so I can&rsquo;t do much analysis.
Sorry!</p><h2 id=stage-4-1>Stage 4</h2><p>This is a rather destructive final stage. It contains a list of file extensions that it will attempt to corrupt and then finally it will delete itself. To ensure the device is still &ldquo;operable&rdquo; it will ignore files in the <code>Windows</code> directory.</p><p>File Corrupter Function:</p><p><img src=/p/whispergate/Pasted_image_20220130023351.png width=701 height=653 srcset="/p/whispergate/Pasted_image_20220130023351_hu06e122d69c6b3e8aa1557dadbd7e580e_56595_480x0_resize_box_3.png 480w, /p/whispergate/Pasted_image_20220130023351_hu06e122d69c6b3e8aa1557dadbd7e580e_56595_1024x0_resize_box_3.png 1024w" loading=lazy alt=image class=gallery-image data-flex-grow=107 data-flex-basis=257px>
Opening File:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>_File = _wfopen(Filename,L&#34;wb&#34;);
</span></span></code></pre></td></tr></table></div></div><p>Writing data to file (Corrupting it in the process):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>fwrite(_Str,1,0x100000,_File);
</span></span></code></pre></td></tr></table></div></div><p>Renaming file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>_wrename(Filename,pwVar2);
</span></span></code></pre></td></tr></table></div></div><p>Deletes self after being ran:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cmd.exe /min /C ping 111.111.111.111 -n 5 -w 10 &gt; Nul &amp; Del /f /q &#34;%s&#34;
</span></span></code></pre></td></tr></table></div></div><h3 id=lab-analysis>Lab Analysis:</h3><p>Creating test files inside users download folder:
<img src=https://media.discordapp.net/attachments/437733241496141826/937433471649992814/unknown.png loading=lazy alt=Image>
<img src=https://media.discordapp.net/attachments/437733241496141826/937433472186871888/unknown.png loading=lazy alt=Image></p><p>Files after execution of stage_4.exe: (Note the randomized file extensions)
<img src=https://media.discordapp.net/attachments/437733241496141826/937433471196999680/unknown.png loading=lazy alt=Image>
<img src="https://media.discordapp.net/attachments/437733241496141826/937433470500761610/unknown.png?width=810&height=575" loading=lazy alt=Image></p><h3 id=sysmon-logs-generated>Sysmon logs generated:</h3><p>Changing file extension and overwriting data:
<img src=https://media.discordapp.net/attachments/437733241496141826/937433402125209680/unknown.png loading=lazy alt=Image></p><p>Executing cleanup command to evade detection:
<img src=https://media.discordapp.net/attachments/437733241496141826/937433402464944198/unknown.png loading=lazy alt=Image></p><p>Corrupting additional files:
<img src=https://media.discordapp.net/attachments/437733241496141826/937433401621880862/unknown.png loading=lazy alt=Image></p><h3 id=detection-rules-2>Detection Rules:</h3><h4 id=yara-2>Yara:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rule whisphergate_stage_4 {
</span></span><span class=line><span class=cl>    meta:
</span></span><span class=line><span class=cl>        author = &#34;Nathan Burns&#34;
</span></span><span class=line><span class=cl>        date = &#34;1/30/2022&#34;
</span></span><span class=line><span class=cl>        md5 = &#34;3907c7fbd4148395284d8e6e3c1dba5d&#34;
</span></span><span class=line><span class=cl>	strings:
</span></span><span class=line><span class=cl>		$f1 = &#34;cmd.exe /min /C ping 111.111.111.111 -n 5 -w 10 &gt; Nul &amp; Del /f /q&#34;
</span></span><span class=line><span class=cl>		$x1 = &#34;.BACKUP&#34; wide ascii
</span></span><span class=line><span class=cl>		$x2 = &#34;.SQLITE3&#34; wide ascii
</span></span><span class=line><span class=cl>		$x3 = &#34;.DOCX&#34; wide ascii 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	condition:
</span></span><span class=line><span class=cl>		$f1 and 1 of ($x*)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=mitre-attck-techniques-2>MITRE ATT&CK Techniques:</h3><p><a class=link href=https://attack.mitre.org/techniques/T1485/ target=_blank rel=noopener>T1485 - Data Destruction</a><br><a class=link href=https://attack.mitre.org/techniques/T1070/004/ target=_blank rel=noopener>T1070.004 - Indicator Removal on Host: File Deletion</a></p><h2 id=conclusion>Conclusion</h2><p>This malware attack was focused on one thing, causing damage and destroying data. There are no attempts to exfiltrate data or take control of any systems leading me to believe the primary goal of this attack was to sow doubt in Ukraine&rsquo;s ability to defend itself in cyber space. It would be a crime not to mention how this attack coincides with the current Russian military buildup on Ukraine&rsquo;s border.</p><p>You may have noticed some changes from my regular blog posts, most notably including YARA rules and MITRE ATT&CK Techniques. I&rsquo;m hoping these additions help defenders secure their networks against these attacks and help me improve my own skills.</p><p>Analyzing this sample has been an amazing learning experience, if you have any suggestions or concerns, please don&rsquo;t hestitate to <a class=link href=/contact>contact me</a>.</p><h2 id=references>References:</h2><ul><li><a class=link href=https://elastic.github.io/security-research/malware/2022/01/01.operation-bleeding-bear/article/ target=_blank rel=noopener>https://elastic.github.io/security-research/malware/2022/01/01.operation-bleeding-bear/article/</a> Great article that has information on Stage 3.</li><li><a class=link href=https://www.microsoft.com/security/blog/2022/01/15/destructive-malware-targeting-ukrainian-organizations/ target=_blank rel=noopener>https://www.microsoft.com/security/blog/2022/01/15/destructive-malware-targeting-ukrainian-organizations/</a> Original Microsoft blog on WhisperGate.</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/destructive-malware/>Destructive Malware</a>
<a href=/tags/yara/>Yara</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/mirai_botnet/><div class=article-image><img src=https://m.media-amazon.com/images/I/41ZJaKEDzNL._AC_SX355_.jpg loading=lazy data-key=mirai_botnet data-hash=https://m.media-amazon.com/images/I/41ZJaKEDzNL._AC_SX355_.jpg></div><div class=article-details><h2 class=article-title>Analysis of Mirai Malware</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Nathan's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>