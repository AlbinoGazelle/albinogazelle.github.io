<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Destructive Malware on Nathan's Blog</title><link>https://demo.stack.jimmycai.com/tags/destructive-malware/</link><description>Recent content in Destructive Malware on Nathan's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sun, 16 Jan 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://demo.stack.jimmycai.com/tags/destructive-malware/index.xml" rel="self" type="application/rss+xml"/><item><title>Deconstructing WhisperGate</title><link>https://demo.stack.jimmycai.com/p/whispergate/</link><pubDate>Sun, 16 Jan 2022 00:00:00 +0000</pubDate><guid>https://demo.stack.jimmycai.com/p/whispergate/</guid><description>&lt;img src="https://demo.stack.jimmycai.com/p/whispergate/whisper.jpg" alt="Featured image of post Deconstructing WhisperGate" />&lt;h1 id="introduction">Introduction&lt;/h1>
&lt;p>Destructive malware is some of the most dangerous software out there. Where a malicious coin miner might slow down your system or a RAT might be used to exfiltrate sensitive data, destructive malware exists for one purpose, causing damage. Arguably one of the most popular cyber attacks in history Stuxnet, was destructive in nature. The main aspect of ransomware that makes it so dangerous is it&amp;rsquo;s destructive nature, if it didn&amp;rsquo;t encrypt a system and make it unusable would anyone pay the ransom?&lt;/p>
&lt;p>On 1/15/2022 Microsoft released information on a new campaign targetting Ukrainian systems with destructive malware. It includes four different stages:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;ol>
&lt;li>A purely destructive MBR wiper that displays a ransom note on next bootup.&lt;/li>
&lt;li>Downloader that&amp;rsquo;s used to download other stages of the attack.&lt;/li>
&lt;li>Payload that adds an exclusion to Windows Defender and allows the final stage to be ran.&lt;/li>
&lt;li>File corrupter that will corrupt any files with a specific extension.&lt;/li>
&lt;/ol>
&lt;h2 id="iocs">IOCs&lt;/h2>
&lt;h3 id="stage-1">Stage 1:&lt;/h3>
&lt;h4 id="sha256">SHA256:&lt;/h4>
&lt;p>&lt;code>a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92&lt;/code>&lt;/p>
&lt;h4 id="unique-strings">Unique Strings:&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">8BEDC411012A33BA34F49130D0F186993C6A32DAD8976F6A5D82C1ED23054C057ECED5496F65
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">You should pay us $10k via bitcoin wallet
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="system-behavior">System Behavior:&lt;/h4>
&lt;p>Overwritting &amp;ldquo;\\.\PhysicalDrive0&amp;rdquo; (MBR) with 512 bytes of the ransom note.&lt;/p>
&lt;h4 id="virustotal">VirusTotal:&lt;/h4>
&lt;p>&lt;a class="link" href="https://www.virustotal.com/gui/file/a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92/detection" target="_blank" rel="noopener"
>https://www.virustotal.com/gui/file/a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92/detection&lt;/a>&lt;/p>
&lt;h3 id="stage-2">Stage 2:&lt;/h3>
&lt;h4 id="sha256-1">SHA256:&lt;/h4>
&lt;p>&lt;code>dcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78&lt;/code>&lt;/p>
&lt;h4 id="unique-strings-1">Unique Strings:&lt;/h4>
&lt;p>:::info
Make sure to specify 16 byte length when running strings &lt;code>strings -e b file_name&lt;/code> to see these.
:::&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">DxownxloxadDxatxxax
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">ttps://cdn.discordapp.com/attachments/928503440139771947/930108637681184768/Tbopbh.jpg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="system-behavior-1">System Behavior:&lt;/h4>
&lt;p>Powershell executing a base64 encoded payload.&lt;br>
DNS request and subsequent file download from cdn.discordapp.com&lt;/p>
&lt;h4 id="virustotal-1">VirusTotal:&lt;/h4>
&lt;p>&lt;a class="link" href="https://www.virustotal.com/gui/file/dcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78" target="_blank" rel="noopener"
>https://www.virustotal.com/gui/file/dcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78&lt;/a>&lt;/p>
&lt;h3 id="stage-3">Stage 3:&lt;/h3>
&lt;h4 id="sha256-2">SHA256:&lt;/h4>
&lt;p>&lt;code>9ef7dbd3da51332a78eff19146d21c82957821e464e8133e9594a07d716d892d&lt;/code>&lt;/p>
&lt;h4 id="virustotal-2">VirusTotal:&lt;/h4>
&lt;p>&lt;a class="link" href="https://www.virustotal.com/gui/file/9ef7dbd3da51332a78eff19146d21c82957821e464e8133e9594a07d716d892d" target="_blank" rel="noopener"
>https://www.virustotal.com/gui/file/9ef7dbd3da51332a78eff19146d21c82957821e464e8133e9594a07d716d892d&lt;/a>&lt;/p>
&lt;h3 id="stage-4">Stage 4:&lt;/h3>
&lt;h4 id="sha256-3">SHA256:&lt;/h4>
&lt;p>&lt;code>34ca75a8c190f20b8a7596afeb255f2228cb2467bd210b2637965b61ac7ea907&lt;/code>&lt;/p>
&lt;h4 id="unique-strings-2">Unique Strings:&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cmd.exe /min /C ping 111.111.111.111 -n 5 -w 10 &amp;gt; Nul &amp;amp; Del /f /q &amp;#34;%s&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="system-behavior-2">System Behavior:&lt;/h4>
&lt;p>Mass file writing and data corruption.&lt;br>
Pinging 111.111.111.111 and then deleting itself.&lt;/p>
&lt;h4 id="virustotal-3">VirusTotal:&lt;/h4>
&lt;p>&lt;a class="link" href="https://www.virustotal.com/gui/file/34ca75a8c190f20b8a7596afeb255f2228cb2467bd210b2637965b61ac7ea907" target="_blank" rel="noopener"
>https://www.virustotal.com/gui/file/34ca75a8c190f20b8a7596afeb255f2228cb2467bd210b2637965b61ac7ea907&lt;/a>&lt;/p>
&lt;h2 id="stage-1-1">Stage 1&lt;/h2>
&lt;p>Stage 1 is a pretty basic executable. Essentially all it does is overwrite the MBR with the ransom note. It uses &lt;em>CreateFileW&lt;/em> to create a file handler pointing to the Master Boot Record and uses &lt;em>WriteFile&lt;/em> to overwrite the MBR with the ransom note.&lt;/p>
&lt;p>Once this stage is executed the host machine is left inoperable. Interestingly enough, if a machine is utilizing UEFI (and cmon, its 2022. Every machine should be) the ransom note &lt;strong>will not&lt;/strong> be displayed on next bootup but the host will still be inoperable.&lt;/p>
&lt;p>Screenshot of impacted host:
&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937151814409793556/unknown.png"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;p>The ransom note is quite humorous as by the time any user sees this message, the computer has been damaged and the MBR already wiped and there is no function to fix any damage caused. Thankfully no one has fallen for this and the BTC address has not received much BTC at the time of this post:
&lt;a class="link" href="https://www.blockchain.com/btc/address/1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv" target="_blank" rel="noopener"
>1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129094431.png"
width="784"
height="335"
srcset="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129094431_huabf36fdd2d46129dbb4886a5c9c4c37d_26995_480x0_resize_box_3.png 480w, https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129094431_huabf36fdd2d46129dbb4886a5c9c4c37d_26995_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image"
class="gallery-image"
data-flex-grow="234"
data-flex-basis="561px"
>&lt;/p>
&lt;p>Decompiled wiper function:
&lt;img src="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129093558.png"
width="706"
height="145"
srcset="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129093558_hud364b51e44e62b5c90424431657e225e_28472_480x0_resize_box_3.png 480w, https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129093558_hud364b51e44e62b5c90424431657e225e_28472_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image"
class="gallery-image"
data-flex-grow="486"
data-flex-basis="1168px"
>&lt;/p>
&lt;h3 id="detection-rules">Detection Rules:&lt;/h3>
&lt;h4 id="yara">Yara:&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rule whispergate_stage_1 {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> meta:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> author = &amp;#34;Nathan Burns&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> date = &amp;#34;1/30/2022&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> md5 = &amp;#34;5d5c99a08a7d927346ca2dafa7973fc1&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> strings:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $s1 = &amp;#34;1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $s2 = &amp;#34;8BEDC411012A33BA34F49130D0F186993C6A32DAD8976F6A5D82C1ED23054C057ECED5496F65&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $f1 = &amp;#34;WriteFile&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $f2 = &amp;#34;CreateFileW&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> condition:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 of ($s*) and 1 of ($f*)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="mitre-attck-techniques">MITRE ATT&amp;amp;CK Techniques&lt;/h3>
&lt;p>&lt;a class="link" href="https://attack.mitre.org/techniques/T1561/002/" target="_blank" rel="noopener"
>T1561.002 - Disk Structure Wipe&lt;/a>&lt;br>
&lt;a class="link" href="https://attack.mitre.org/techniques/T1491/001/" target="_blank" rel="noopener"
>T1491.001 - Internal Defacement&lt;/a>&lt;/p>
&lt;h2 id="stage-2-1">Stage 2&lt;/h2>
&lt;p>Stage 2 is where it gets more complex. It contains obfuscated code and starts downloading the next stage. I have zero experience decompiling .NET malware, but I was able to grab some interesting strings and see some weird behavior. A very interesting string is that this stage attempts to pull malware from discord, behavior that&amp;rsquo;s been seen in the &lt;a class="link" href="https://cyware.com/news/abuse-of-discord-cdn-witnesses-significant-rise-277d273d" target="_blank" rel="noopener"
>past.&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129125130.png"
width="720"
height="89"
srcset="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129125130_hu19efaee94e6c2a5aabbd3f97bf582b70_9528_480x0_resize_box_3.png 480w, https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129125130_hu19efaee94e6c2a5aabbd3f97bf582b70_9528_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image"
class="gallery-image"
data-flex-grow="808"
data-flex-basis="1941px"
>&lt;/p>
&lt;p>It also attempts to evade detection by &amp;ldquo;obfuscating&amp;rdquo; some variables
&lt;img src="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129125228.png"
width="424"
height="80"
srcset="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129125228_hu269e446a133117cb154177a2af698962_5510_480x0_resize_box_3.png 480w, https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220129125228_hu269e446a133117cb154177a2af698962_5510_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image"
class="gallery-image"
data-flex-grow="530"
data-flex-basis="1272px"
>&lt;/p>
&lt;p>It&amp;rsquo;s my guess that this stage is purely a dropper for stage 3, but my .NET decompilation skills are extremely weak so I decided to just run it in a closed lab environment with some sysmon rules. I plan on making a blogpost later on after I create a more detailed and &lt;em>hopefully&lt;/em> safer malware analysis lab.&lt;/p>
&lt;p>Anyways, this was the behavior I spotted after running it in a lab environment.&lt;/p>
&lt;p>The first thing it does it run this obfuscated powershell command:&lt;/p>
&lt;p>&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937211009926594650/vmware_gEbM5IIhfa.png"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;p>Decoded command:&lt;/p>
&lt;p>&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937211008685047838/vmware_FIWwAGCyAz.png"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;p>This command sleeps the script for 10 seconds until it downloads the stage 3 binary from &lt;strong>cdn.discordapp.com&lt;/strong>, presumably using the obfuscated &lt;strong>DownloadData&lt;/strong> powershell command.&lt;/p>
&lt;p>&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937211009184186418/vmware_ZTnw9fJTgk.png"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;p>This is all I could gather from the stage 2 binary, but it most certainly executes the stage 3 binary after successful download as well.&lt;/p>
&lt;h3 id="detection-rules-1">Detection Rules:&lt;/h3>
&lt;h4 id="yara-1">YARA:&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rule whispergate_stage_2 {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> meta:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> author = &amp;#34;Nathan Burns&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> date = &amp;#34;1/30/2022&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> md5 = &amp;#34;14c8482f302b5e81e3fa1b18a509289d&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> strings:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $s1 = &amp;#34;DxownxloxadDxatxxax&amp;#34; wide ascii
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $s2 = &amp;#34;ttps://cdn.discordapp.com/attachments/928503440139771947/930108637681184768/Tbopbh.jpg&amp;#34; wide ascii
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> condition:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $s1 or $s2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="mitre-attck-techniques-1">MITRE ATT&amp;amp;CK Techniques&lt;/h3>
&lt;p>&lt;a class="link" href="https://attack.mitre.org/techniques/T1059/001/" target="_blank" rel="noopener"
>T1059.001 - Command and Scripting Interpreter: PowerShell&lt;/a>&lt;br>
&lt;a class="link" href="https://attack.mitre.org/techniques/T1583/006/" target="_blank" rel="noopener"
>T1583.006 - Acquire Infrastructure: Web Services&lt;/a>&lt;/p>
&lt;h2 id="stage-3-1">Stage 3&lt;/h2>
&lt;p>Unfortunately I couldn&amp;rsquo;t get my hands on the original stage 3 binary so I can&amp;rsquo;t do much analysis.
Sorry!&lt;/p>
&lt;h2 id="stage-4-1">Stage 4&lt;/h2>
&lt;p>This is a rather destructive final stage. It contains a list of file extensions that it will attempt to corrupt and then finally it will delete itself. To ensure the device is still &amp;ldquo;operable&amp;rdquo; it will ignore files in the &lt;code>Windows&lt;/code> directory.&lt;/p>
&lt;p>File Corrupter Function:&lt;/p>
&lt;p>&lt;img src="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220130023351.png"
width="701"
height="653"
srcset="https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220130023351_hu06e122d69c6b3e8aa1557dadbd7e580e_56595_480x0_resize_box_3.png 480w, https://demo.stack.jimmycai.com/p/whispergate/Pasted_image_20220130023351_hu06e122d69c6b3e8aa1557dadbd7e580e_56595_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image"
class="gallery-image"
data-flex-grow="107"
data-flex-basis="257px"
>
Opening File:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">_File = _wfopen(Filename,L&amp;#34;wb&amp;#34;);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Writing data to file (Corrupting it in the process):&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">fwrite(_Str,1,0x100000,_File);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Renaming file:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">_wrename(Filename,pwVar2);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Deletes self after being ran:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cmd.exe /min /C ping 111.111.111.111 -n 5 -w 10 &amp;gt; Nul &amp;amp; Del /f /q &amp;#34;%s&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;h3 id="lab-analysis">Lab Analysis:&lt;/h3>
&lt;p>Creating test files inside users download folder:
&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937433471649992814/unknown.png"
loading="lazy"
alt="Image"
>
&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937433472186871888/unknown.png"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;p>Files after execution of stage_4.exe: (Note the randomized file extensions)
&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937433471196999680/unknown.png"
loading="lazy"
alt="Image"
>
&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937433470500761610/unknown.png?width=810&amp;amp;height=575"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;h3 id="sysmon-logs-generated">Sysmon logs generated:&lt;/h3>
&lt;p>Changing file extension and overwriting data:
&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937433402125209680/unknown.png"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;p>Executing cleanup command to evade detection:
&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937433402464944198/unknown.png"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;p>Corrupting additional files:
&lt;img src="https://media.discordapp.net/attachments/437733241496141826/937433401621880862/unknown.png"
loading="lazy"
alt="Image"
>&lt;/p>
&lt;h3 id="detection-rules-2">Detection Rules:&lt;/h3>
&lt;h4 id="yara-2">Yara:&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rule whisphergate_stage_4 {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> meta:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> author = &amp;#34;Nathan Burns&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> date = &amp;#34;1/30/2022&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> md5 = &amp;#34;3907c7fbd4148395284d8e6e3c1dba5d&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> strings:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $f1 = &amp;#34;cmd.exe /min /C ping 111.111.111.111 -n 5 -w 10 &amp;gt; Nul &amp;amp; Del /f /q&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $x1 = &amp;#34;.BACKUP&amp;#34; wide ascii
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $x2 = &amp;#34;.SQLITE3&amp;#34; wide ascii
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $x3 = &amp;#34;.DOCX&amp;#34; wide ascii
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> condition:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> $f1 and 1 of ($x*)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="mitre-attck-techniques-2">MITRE ATT&amp;amp;CK Techniques:&lt;/h3>
&lt;p>&lt;a class="link" href="https://attack.mitre.org/techniques/T1485/" target="_blank" rel="noopener"
>T1485 - Data Destruction&lt;/a>&lt;br>
&lt;a class="link" href="https://attack.mitre.org/techniques/T1070/004/" target="_blank" rel="noopener"
>T1070.004 - Indicator Removal on Host: File Deletion&lt;/a>&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>This malware attack was focused on one thing, causing damage and destroying data. There are no attempts to exfiltrate data or take control of any systems leading me to believe the primary goal of this attack was to sow doubt in Ukraine&amp;rsquo;s ability to defend itself in cyber space. It would be a crime not to mention how this attack coincides with the current Russian military buildup on Ukraine&amp;rsquo;s border.&lt;/p>
&lt;p>You may have noticed some changes from my regular blog posts, most notably including YARA rules and MITRE ATT&amp;amp;CK Techniques. I&amp;rsquo;m hoping these additions help defenders secure their networks against these attacks and help me improve my own skills.&lt;/p>
&lt;p>Analyzing this sample has been an amazing learning experience, if you have any suggestions or concerns, please don&amp;rsquo;t hestitate to &lt;a class="link" href="https://demo.stack.jimmycai.com/contact" >contact me&lt;/a>.&lt;/p>
&lt;h2 id="references">References:&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://elastic.github.io/security-research/malware/2022/01/01.operation-bleeding-bear/article/" target="_blank" rel="noopener"
>https://elastic.github.io/security-research/malware/2022/01/01.operation-bleeding-bear/article/&lt;/a> Great article that has information on Stage 3.&lt;/li>
&lt;li>&lt;a class="link" href="https://www.microsoft.com/security/blog/2022/01/15/destructive-malware-targeting-ukrainian-organizations/" target="_blank" rel="noopener"
>https://www.microsoft.com/security/blog/2022/01/15/destructive-malware-targeting-ukrainian-organizations/&lt;/a> Original Microsoft blog on WhisperGate.&lt;/li>
&lt;/ul></description></item></channel></rss>